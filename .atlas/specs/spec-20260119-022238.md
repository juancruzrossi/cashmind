# Feature: Evaluación de Salud Financiera

## Overview
Sistema de evaluación financiera que calcula un score basado en 4 métricas clave (tasa de ahorro, ratio gastos fijos, adherencia a presupuesto, tendencia mensual) y lo presenta en formato semáforo (Rojo/Amarillo/Verde). Incluye consejos personalizados generados por Gemini y un historial visual de evolución mensual.

## Requirements

### Functional
- FR-1: Calcular score de salud financiera basado en 4 métricas ponderadas
- FR-2: Mostrar semáforo individual por cada métrica + semáforo global
- FR-3: Generar consejos personalizados con Gemini para métricas en rojo/amarillo
- FR-4: Guardar snapshots mensuales del score para historial
- FR-5: Mostrar gráfica de evolución del score a lo largo del tiempo
- FR-6: Widget en dashboard con semáforo global (solo visual)
- FR-7: Sección dedicada con desglose completo y consejos
- FR-8: Onboarding guiado cuando no hay datos suficientes

### Non-Functional
- NFR-1: Score se calcula al abrir la sección (no en tiempo real)
- NFR-2: Consejos de Gemini se cachean hasta que el usuario pulse "regenerar"
- NFR-3: API debe responder en <500ms para el cálculo del score

## Technical Design

### Approach
- Backend: Nuevo endpoint `/api/health-score/` que calcula métricas y score
- Backend: Nuevo modelo `HealthScoreSnapshot` para historial mensual
- Backend: Endpoint `/api/health-score/advice/` para consejos de Gemini
- Frontend: Nueva sección `/health` con detalle completo
- Frontend: Widget `HealthScoreWidget` para dashboard

### Components Affected

**Backend:**
- `api/models.py` - Nuevo modelo `HealthScoreSnapshot`
- `api/views.py` - Nuevos endpoints de health score
- `api/urls.py` - Rutas para health score
- `api/services/gemini.py` - Nuevo método para consejos financieros
- `api/serializers.py` - Serializers para health score

**Frontend:**
- `app/(dashboard)/health/page.tsx` - Nueva página de salud financiera
- `components/dashboard/HealthScoreWidget.tsx` - Widget para dashboard
- `components/health/` - Componentes de la sección (MetricCard, AdvicePanel, HistoryChart)
- `hooks/useHealthScore.ts` - Hook para fetch de datos
- `lib/api.ts` - Métodos para health score API

### Data Model

```python
class HealthScoreSnapshot(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    month = models.DateField()  # Primer día del mes evaluado

    # Scores individuales (0-100)
    savings_rate_score = models.IntegerField()
    fixed_expenses_score = models.IntegerField()
    budget_adherence_score = models.IntegerField()
    trend_score = models.IntegerField()

    # Score global (0-100)
    overall_score = models.IntegerField()

    # Status semáforo: 'red', 'yellow', 'green'
    overall_status = models.CharField(max_length=10)

    # Consejo cacheado de Gemini
    cached_advice = models.TextField(null=True, blank=True)
    advice_generated_at = models.DateTimeField(null=True)

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ['user', 'month']
```

### Cálculo de Métricas

**1. Tasa de Ahorro (savings_rate)**
```
savings_rate = (ingresos - gastos) / ingresos * 100
Verde: >= 20%
Amarillo: 10-19%
Rojo: < 10% o sin ingresos
```

**2. Ratio Gastos Fijos (fixed_expenses_ratio)**
```
Categorías fijas: vivienda, servicios, transporte, seguros
fixed_ratio = gastos_fijos / ingresos * 100
Verde: <= 40%
Amarillo: 41-55%
Rojo: > 55%
```

**3. Adherencia a Presupuesto (budget_adherence)**
```
categorias_en_presupuesto = categorías con Budget definido
categorias_cumplidas = categorías donde gasto <= límite
adherence = categorias_cumplidas / categorias_en_presupuesto * 100
Verde: >= 80%
Amarillo: 50-79%
Rojo: < 50% o sin presupuestos definidos
```

**4. Tendencia Mensual (trend)**
```
Comparar gastos mes actual vs mes anterior
mejora = (gastos_anterior - gastos_actual) / gastos_anterior * 100
Verde: mejora >= 5% o gastos estables
Amarillo: empeora 0-10%
Rojo: empeora > 10%
```

**Score Global**
```
overall = (savings*30 + fixed*25 + budget*25 + trend*20) / 100
Verde: >= 70
Amarillo: 40-69
Rojo: < 40
```

## UX/UI

### User Flow Principal
1. Usuario navega a Dashboard
2. Ve widget con semáforo global de salud financiera
3. Hace click en "Ver detalle" (link, no el widget)
4. Ve sección con 4 cards de métricas (cada una con semáforo)
5. Ve gráfica de evolución mensual
6. Ve panel de consejos con botón "Regenerar consejo"

### Onboarding (sin datos suficientes)
1. Usuario abre sección salud financiera
2. Sistema detecta < 1 mes de transacciones
3. Muestra wizard: "Para evaluar tu salud financiera necesitamos:"
   - Al menos 1 ingreso registrado
   - Al menos 5 transacciones de gastos
   - Presupuestos definidos para al menos 3 categorías
4. Botones para ir a registrar cada elemento faltante

### Error States
- Sin ingresos en el mes: Semáforo automáticamente ROJO con mensaje explicativo
- Error de Gemini: Mostrar consejo predefinido genérico + opción retry
- Sin historial: Mostrar solo evaluación actual sin gráfica

### Componentes UI

**Widget Dashboard (HealthScoreWidget)**
- Círculo con semáforo (verde/amarillo/rojo)
- Texto: "Salud Financiera: [Estado]"
- Sin interacción (link "Ver detalle" separado)

**Sección Salud (/health)**
- Header con semáforo global grande + score numérico
- Grid 2x2 de MetricCards:
  - Tasa de Ahorro (icono piggy bank)
  - Gastos Fijos (icono home)
  - Presupuesto (icono target)
  - Tendencia (icono trending)
- Gráfica de evolución (line chart, últimos 6-12 meses)
- Panel de consejos con botón regenerar

**MetricCard**
- Semáforo pequeño
- Nombre de métrica
- Valor actual (ej: "23%")
- Barra de progreso visual

## Out of Scope
- Comparación con otros usuarios/benchmarks externos
- Integración con bancos para datos automáticos
- Alertas push cuando el score cambia
- Exportar reporte de salud financiera
- Metas de score personalizables por el usuario
- Peso configurable de métricas en score global

## Acceptance Criteria
- [ ] AC-1: Endpoint `/api/health-score/` devuelve score y 4 métricas con status
- [ ] AC-2: Widget muestra semáforo correcto basado en overall_status
- [ ] AC-3: Sección muestra 4 MetricCards con semáforo individual
- [ ] AC-4: Gráfica muestra evolución de últimos 6 meses si hay historial
- [ ] AC-5: Botón "Regenerar consejo" llama a Gemini y actualiza panel
- [ ] AC-6: Onboarding aparece cuando hay < 1 ingreso o < 5 gastos
- [ ] AC-7: Mes sin ingresos muestra automáticamente semáforo rojo

## Interview Summary

**Decisiones clave:**
- Formato semáforo de 3 niveles (Rojo/Amarillo/Verde) por simplicidad
- Todas las 4 métricas incluidas: ahorro, gastos fijos, presupuesto, tendencia
- Tasa de ahorro óptima: 20% (regla 50/30/20)
- Gastos fijos máximo saludable: 40% (incluye vivienda, servicios, transporte, seguros)
- Consejos generados por IA (Gemini) con cache y botón manual para regenerar
- Cálculo en backend para consistencia y facilitar historial
- Historial con gráfica de evolución mensual
- Widget solo visual (sin click), link separado para detalle
- Sin ingresos = automáticamente rojo (sin workarounds)
- Onboarding guiado para nuevos usuarios sin datos suficientes
